# Multi-stage Dockerfile for Java/Kotlin with Gradle
# Variables:
# - .BaseImageBuilder (default: 'gradle:8.10-jdk17')
# - .BaseImageRuntime (default: 'eclipse-temurin:17-jre')
# - .AppWorkdir (default: '/app')
# - .GradleOpts (map[string]string) e.g. JAVA_TOOL_OPTIONS
# - .BuildArgs, .Env
# - .JarOutputPath (optional)
# - .Entrypoint, .ExposePort
# - .SkipTests (default 'false')

# syntax=docker/dockerfile:1.7
ARG BUILDER_IMAGE={{ default "gradle:8.10-jdk17" .BaseImageBuilder }}
ARG RUNTIME_IMAGE={{ default "eclipse-temurin:17-jre" .BaseImageRuntime }}

FROM ${BUILDER_IMAGE} AS builder
WORKDIR {{ default "/app" .AppWorkdir }}

{{- range $k, $v := .BuildArgs }}
ARG {{ $k }}={{ $v }}
{{- end }}

{{- range $k, $v := .Env }}
ENV {{ $k }}="{{ $v }}"
{{- end }}

{{- range $k, $v := .GradleOpts }}
ENV {{ $k }}="{{ $v }}"
{{- end }}

# Cache Gradle
COPY gradle.* ./ 
COPY settings.gradle* ./
COPY build.gradle* ./
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle --no-daemon dependencies

# Copy sources
COPY . ./
RUN --mount=type=cache,target=/home/gradle/.gradle \
    gradle --no-daemon build -x test={{ if eq (default "false" .SkipTests) "true" }}true{{ else }}false{{ end }}

# Runtime
FROM ${RUNTIME_IMAGE} AS runtime
WORKDIR {{ default "/app" .AppWorkdir }}

{{- if .JarOutputPath }}
COPY --from=builder {{ .JarOutputPath }} /app/app.jar
{{- else }}
COPY --from=builder /app/build/libs/*.jar /app/app.jar
{{- end }}

{{- if .ExposePort }}
EXPOSE {{ .ExposePort }}
{{- end }}

{{- if .Entrypoint }}
ENTRYPOINT [{{- range $i, $e := .Entrypoint -}}{{ if $i }}, {{ end }}"{{ $e }}"{{- end -}}]
{{- else }}
ENTRYPOINT ["java","-jar","/app/app.jar"]
{{- end }}
