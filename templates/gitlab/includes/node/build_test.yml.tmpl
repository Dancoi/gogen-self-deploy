# (Include) Node build + test fragment
# Expects variables: NODE_VERSION, APP_NAME
# Provides stages: install, test, build

install_node:
  stage: install
  image: node:${NODE_VERSION}-alpine
  cache:
    key: "node-${CI_COMMIT_REF_SLUG}"
    paths:
      - .cache/npm/
  script:
    - mkdir -p .cache/npm
    - if [ -f package-lock.json ]; then npm ci; else npm install; fi
  artifacts:
    name: "${APP_NAME}-deps-${CI_COMMIT_SHORT_SHA}"
    when: on_success
    expire_in: 1h
    paths:
      - node_modules/
  rules:
    - when: always

test_node:
  stage: test
  image: node:${NODE_VERSION}-alpine
  cache:
    key: "node-${CI_COMMIT_REF_SLUG}"
    paths:
      - .cache/npm/
  needs: [install_node]
  script:
    - if npm run | grep -q "test"; then npm test --if-present || echo "tests failed or absent"; else echo "no test script"; fi
  artifacts:
    name: "${APP_NAME}-test-${CI_COMMIT_SHORT_SHA}"
    when: always
    expire_in: 1 week
    paths:
      - junit.xml
    reports:
      junit: junit.xml
  rules:
    - when: always

build_node:
  stage: build
  image: node:${NODE_VERSION}-alpine
  cache:
    key: "node-${CI_COMMIT_REF_SLUG}"
    paths:
      - .cache/npm/
  needs: [install_node]
  script:
    - if npm run | grep -q "build"; then npm run build; else echo "no build script"; fi
    - if [ -d "dist" ]; then echo "dist exists"; else mkdir -p dist; fi
  artifacts:
    name: "${APP_NAME}-build-${CI_COMMIT_SHORT_SHA}"
    when: always
    expire_in: 1 week
    paths:
      - dist/
  rules:
    - when: always

