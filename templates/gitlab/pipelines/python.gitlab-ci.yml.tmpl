# GitLab CI/CD конфигурация для Python-проектов с поддержкой
# различных менеджеров зависимостей (poetry, pipenv, requirements.txt),
# тестированием, анализом SonarQube и сборкой Docker-образов.
# Ожидаемые поля из контекста: .Report.LanguageVersion (опционально),
# .Report.AppPort, .Opt.SonarHost, .Opt.RegistryProject, .Now

# Стадии: build -> test -> sonar -> docker -> deploy
stages:
  - build
  - test
  - sonar
  - docker
  - deploy_staging
  - deploy_production

# Переменные, которые можно переопределить
variables:
  PIP_CACHE_DIR: ".cache/pip"
  VENV_PATH: ".venv"
  # Sonar: передавайте SONAR_TOKEN в CI/CD variables
  SONAR_HOST_URL: "{{ .Opt.SonarHost }}"

# Общие настройки runner'а/образа можно менять в job'ах ниже.

# Build & Test job — стараемся быть гибкими: поддержка poetry/pipenv/requirements
build_test:
  stage: build
  image: python:{{ if .Report.LanguageVersion }}{{ .Report.LanguageVersion }}{{ else }}3.12{{ end }}-slim
  # Кешируем зависимости
  cache:
    key: "pip-{{ .CI_COMMIT_REF_SLUG }}"
    paths:
      - .cache/pip/
      - .venv/
  script:
    - echo ">>> Создание виртуального окружения и установка зависимостей (если есть)"
    - python -m venv $VENV_PATH
    - . $VENV_PATH/bin/activate
    - pip install --upgrade pip setuptools wheel
    - |
      if [ -f pyproject.toml ] && grep -qi poetry pyproject.toml; then
        echo "Detected poetry; using poetry to install"
        pip install poetry
        poetry install --no-interaction --no-root
      elif [ -f Pipfile ]; then
        echo "Detected Pipfile; using pipenv"
        pip install pipenv
        pipenv install --deploy --ignore-pipfile
      elif [ -f requirements.txt ]; then
        echo "Detected requirements.txt; using pip"
        pip install -r requirements.txt
      else
        echo "No dependency manifest found; continuing"
      fi
    - |
      # Запуск тестов (если есть)
      if python -c "import pytest" >/dev/null 2>&1; then
        pytest -q || echo "pytest failed (tests may be absent)"
      else
        # popt: если нет pytest, попробуем запустить unittest discovery
        python -m unittest discover -v || echo "no tests or failures"
      fi
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - pytest.xml || []
      - .venv/

# SonarQube stage: запускается если задан SONAR_TOKEN
sonar:
  stage: sonar
  image: sonarsource/sonar-scanner-cli:latest
  rules:
    - if: '$SONAR_TOKEN'
  variables:
    SONAR_HOST_URL: "{{ .Opt.SonarHost }}"
    SONAR_LOGIN: "$SONAR_TOKEN"
  script:
    - sonar-scanner -Dsonar.projectKey=$CI_PROJECT_NAME -Dsonar.sources=.
  allow_failure: true

# Docker build & push (использует Docker-in-Docker образ)
docker_build_push:
  stage: docker
  image: docker:24.0.7
  services:
    - name: docker:24.0.7-dind
      command: ["--tls=false"]
  variables:
    DOCKER_DRIVER: overlay2
  before_script:
    - echo "Docker login if credentials provided"
    - |
      if [ -n "$CI_REGISTRY" ] && [ -n "$CI_REGISTRY_USER" ] && [ -n "$CI_REGISTRY_PASSWORD" ]; then
        echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
      fi
  script:
    - IMAGE="${CI_REGISTRY_IMAGE:-{{ .Opt.RegistryProject }}}"
    - TAG="${CI_COMMIT_SHORT_SHA:-local}"
    - if [ -z "$IMAGE" ]; then echo "No image configured, set Opt.RegistryProject or use GitLab registry"; exit 1; fi
    - docker build -t "$IMAGE:$TAG" -f Dockerfile .
    - docker push "$IMAGE:$TAG"
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ] || [ "$CI_COMMIT_BRANCH" = "master" ]; then
        docker tag "$IMAGE:$TAG" "$IMAGE:latest"
        docker push "$IMAGE:latest"
      fi
  only:
    - branches
  artifacts:
    expire_in: 1 week
    paths:
      - image-info.txt || []

# Простейшие деплой-джобы (плейсхолдеры)
deploy_staging:
  stage: deploy_staging
  when: manual
  script:
    - echo "Placeholder: deploy to staging (implement per infra: ssh/k8s/helm/ansible)"
  environment:
    name: staging
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(develop|staging)$/'

deploy_production:
  stage: deploy_production
  when: manual
  script:
    - echo "Placeholder: deploy to production (implement per infra)"
  environment:
    name: production
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(main|master)$/'